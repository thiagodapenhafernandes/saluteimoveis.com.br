<%= form_with(model: [:admin, @landing_page], local: true, class: "row g-4", data: { controller: "property-page-preview", property_page_preview_url_value: "/admin/landing_pages/preview" }) do |f| %>
  <div class="col-lg-8">
    <div class="card-luxury mb-4">
      <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-file-earmark-text me-2"></i>Conteúdo e SEO</h5>
      </div>
      <div class="p-4">
        <div class="mb-3">
          <%= f.label :title, "Título da Página (H1)", class: "form-label fw-bold" %>
          <%= f.text_field :title, class: "form-control form-control-lg", placeholder: "Ex: Apartamentos na Planta em Balneário Camboriú", required: true %>
        </div>

        <div class="row g-3 mb-3">
          <div class="col-md-6">
            <%= f.label :slug, "URL Amigável (Slug)", class: "form-label fw-bold" %>
            <div class="input-group">
              <span class="input-group-text bg-light text-muted">/</span>
              <%= f.text_field :slug, class: "form-control", placeholder: "apartamentos-na-planta-bc" %>
            </div>
            <small class="text-muted">Deixe em branco para gerar do título.</small>
          </div>
          <div class="col-md-6">
            <%= f.label :meta_title, "Título SEO (Meta Title)", class: "form-label fw-bold" %>
            <%= f.text_field :meta_title, class: "form-control", placeholder: "Título para o Google" %>
          </div>
        </div>

        <div class="mb-3">
          <%= f.label :meta_description, "Descrição SEO (Meta Description)", class: "form-label fw-bold" %>
          <%= f.text_area :meta_description, rows: 2, class: "form-control", placeholder: "Breve resumo para o Google..." %>
        </div>

        <div class="mb-3">
          <%= f.label :description, "Descrição de Topo (Introdução)", class: "form-label fw-bold" %>
          <%= f.text_area :description, rows: 3, class: "form-control", placeholder: "Texto que aparece logo abaixo do título na página pública..." %>
        </div>

        <div class="mb-0">
          <%= f.label :content, "Texto SEO (Rodapé)", class: "form-label fw-bold" %>
          <%= f.text_area :content, rows: 6, class: "form-control", placeholder: "Conteúdo rico para SEO que aparece após a listagem de imóveis..." %>
        </div>
      </div>
    </div>

    <div class="card-luxury mb-4">
      <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-funnel me-2"></i>Atributos (Filtros de Imóveis)</h5>
      </div>
      <div class="p-4">
        <%= f.fields_for :filter_params do |fp| %>
          <div class="row g-3">
            <div class="col-md-6">
              <%= fp.label :category, "Categoria(s)", class: "form-label fw-bold" %>
              <%= fp.select :category, Habitation.active.distinct.pluck(:categoria).compact.sort, { }, { multiple: true, class: "form-select", data: { controller: "tom-select", action: "change->property-page-preview#refresh", tom_select_options_value: { placeholder: "Selecione categorias" } } } %>
            </div>
            <div class="col-md-6">
              <%= fp.label :city, "Cidade(s)", class: "form-label fw-bold" %>
              <%= fp.select :city, Habitation.active.distinct.pluck(:cidade).compact.sort, { }, { multiple: true, class: "form-select", data: { controller: "tom-select", action: "change->property-page-preview#refresh", tom_select_options_value: { placeholder: "Selecione cidades" } } } %>
            </div>
            <div class="col-md-6">
              <%= fp.label :neighborhood, "Bairro(s)", class: "form-label fw-bold" %>
              <%= fp.select :neighborhood, Habitation.active.distinct.order(:bairro).pluck(:bairro).compact.uniq, { }, { multiple: true, class: "form-select", data: { controller: "tom-select", action: "change->property-page-preview#refresh", tom_select_options_value: { placeholder: "Selecione bairros" } } } %>
            </div>
            <div class="col-md-6">
              <%= fp.label :transaction_type, "Transação", class: "form-label fw-bold" %>
              <%= fp.select :transaction_type, [['Venda', 'venda'], ['Aluguel', 'aluguel']], { include_blank: "Todas" }, { class: "form-select", data: { action: "change->property-page-preview#refresh" } } %>
            </div>
            
            <div class="col-md-6">
              <%= fp.label :caracteristica_unica, "Característica Única (Tag/Badge)", class: "form-label fw-bold" %>
              <%= fp.text_field :caracteristica_unica, class: "form-control", placeholder: "Ex: Festival Salute 2026", data: { action: "input->property-page-preview#refresh" } %>
            </div>

            <div class="col-md-6">
              <%= fp.label :target_price, "Preço Sugerido (Range +/- 20%)", class: "form-label fw-bold" %>
              <%= fp.number_field :target_price, class: "form-control", placeholder: "Ex: 1500000", data: { action: "input->property-page-preview#refresh" } %>
            </div>

            <div class="col-md-4">
              <%= fp.label :min_area, "Área Mínima (m²)", class: "form-label fw-bold" %>
              <%= fp.number_field :min_area, class: "form-control", min: 0, data: { action: "input->property-page-preview#refresh" } %>
            </div>

            <div class="col-md-4">
              <%= fp.label :min_bedrooms, "Mín. Dormitórios", class: "form-label fw-bold" %>
              <%= fp.number_field :min_bedrooms, class: "form-control", min: 0, data: { action: "input->property-page-preview#refresh" } %>
            </div>
            <div class="col-md-4">
              <%= fp.label :min_suites, "Mín. Suítes", class: "form-label fw-bold" %>
              <%= fp.number_field :min_suites, class: "form-control", min: 0, data: { action: "input->property-page-preview#refresh" } %>
            </div>
            <div class="col-md-4">
              <%= fp.label :min_parking, "Mín. Vagas", class: "form-label fw-bold" %>
              <%= fp.number_field :min_parking, class: "form-control", min: 0, data: { action: "input->property-page-preview#refresh" } %>
            </div>
          </div>

          <div class="mt-4">
            <label class="form-label fw-bold mb-3 d-block border-bottom pb-2">Características e Flags</label>
            <div class="row g-3">
              <% [
                ['frente_mar', 'Frente Mar'],
                ['quadra_mar', 'Quadra Mar'],
                ['vista_mar', 'Vista Mar'],
                ['piscina', 'Piscina'],
                ['mobiliado', 'Mobiliado'],
                ['churrasqueira', 'Churrasqueira'],
                ['sacada', 'Sacada'],
                ['decorado', 'Decorado'],
                ['lancamento_flag', 'Lançamento'],
                ['aceita_permuta_flag', 'Aceita Permuta'],
                ['aceita_financiamento_flag', 'Aceita Financiamento'],
                ['garden_flag', 'Garden'],
                ['festival_salute_flag', 'Festival Salute'],
                ['exibir_no_site_salute_flag', 'Exibir no Site Salute'],
                ['opportunity', 'Oportunidade (Preço Reduzido)']
              ].each do |value, label| %>
                <div class="col-md-4">
                  <div class="form-check custom-checkbox-card">
                    <%= check_box_tag "landing_page[filter_params][characteristics][]", value, (f.object.filter_params['characteristics'] || []).include?(value), class: "form-check-input", id: "char_#{value}", data: { action: "change->property-page-preview#refresh" } %>
                    <label class="form-check-label w-100 py-1" for="char_<%= value %>">
                      <%= label %>
                    </label>
                  </div>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <div class="col-lg-4">
    <div class="card-luxury mb-4 sticky-top" style="top: 80px;">
      <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-speedometer2 me-2"></i>Resumo do Conjunto</h5>
      </div>
      <div class="p-4">
        <div class="mb-4">
          <div class="badge badge-soft-info w-100 py-2 mb-3" data-property-page-preview-target="count" style="font-size: 0.9rem;">0 imóveis encontrados</div>
          <div id="preview-results" data-property-page-preview-target="results">
           <div class="text-center py-5 text-muted">
              <div class="spinner-border spinner-border-sm text-primary mb-2" role="status"></div>
              <div>Analisando dados...</div>
           </div>
        </div>

        <div class="preview-footer-actions">
          <div class="mb-4">
            <div class="form-check form-switch custom-switch-lg">
               <%= f.check_box :active, class: "form-check-input", id: "activeSwitch" %>
               <%= f.label :active, "Página Ativa para Indexação", class: "form-check-label fw-bold", for: "activeSwitch" %>
            </div>
          </div>

          <div class="d-grid gap-3">
            <%= f.submit "Salvar Página SEO", class: "btn-primary btn-lg w-100" %>
            <%= link_to "Cancelar", admin_landing_pages_path, class: "btn btn-light w-100 text-muted" %>
          </div>
        </div>
      </div>
    </div>
  </div>
<% end %>
